<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 400px;
        margin: 80px auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      h2 {
        text-align: center;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
      }
      button {
        width: 100%;
        padding: 10px;
        margin-top: 10px;
      }
      .message {
        text-align: center;
        margin-top: 10px;
        color: red;
      }
    </style>
  </head>
  <body>
    <h2>Reset Your Password</h2>
    <input type="password" id="new-password" placeholder="New Password" />
    <button onclick="updatePassword()">Update Password</button>
    <p id="message" class="message"></p>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const supabase = createClient(
        "https://litprnfjvytjttlqyhlj.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpdHBybmZqdnl0anR0bHF5aGxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4ODgwMDUsImV4cCI6MjA2NzQ2NDAwNX0.a63MemNyPUF6fds0kD_7OCtklD4_gTUztKqOseGXnsg"
      );

      const message = document.getElementById("message");
      const newPasswordInput = document.getElementById("new-password");

      setTimeout(async () => {
        const urlHash = window.location.hash;
        console.log("Hash:", urlHash);

        const accessToken = urlHash.match(/access_token=([^&]*)/)?.[1];
        const refreshToken = urlHash.match(/refresh_token=([^&]*)/)?.[1];

        console.log("Access Token:", accessToken);
        console.log("Refresh Token:", refreshToken);

        if (accessToken && refreshToken) {
          const { error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken,
          });

          if (error) {
            console.error("Session error:", error.message);
            message.textContent = "Failed to restore session.";
          } else {
            console.log("Session set successfully");
          }
        } else {
          message.textContent = "Missing session tokens.";
        }
      }, 200); // slight delay to ensure hash is available

      // Global function for button click
      window.updatePassword = async function () {
        const newPassword = newPasswordInput.value;
        if (!newPassword) {
          message.textContent = "Please enter a new password.";
          return;
        }

        const { error } = await supabase.auth.updateUser({
          password: newPassword,
        });

        if (error) {
          console.error("Update error:", error.message);
          message.textContent = error.message;
        } else {
          message.style.color = "green";
          message.textContent = "Password updated! You can now log in.";
        }
      };
    </script>
  </body>
</html>
